<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Investor Insights Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="text/javascript" src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
<style>
body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg,#f0f4ff,#fffaf0); color:#333; }
.card { background-color: #ffffff; transition: all 0.3s ease; border-radius:1rem; padding:1.5rem; box-shadow: 0 5px 20px rgba(0,0,0,0.08);}
.card:hover { transform: translateY(-5px); box-shadow:0 10px 25px rgba(0,0,0,0.12);}
.btn { font-weight:600; transition: all 0.2s ease; border-radius:0.75rem;}
.btn:hover { transform: scale(1.05);}
input, select { background-color: #f3f4f6; border:1px solid #ddd; color:#333; padding:0.5rem 1rem; border-radius:0.5rem;}
#network { border-radius: 1rem; border:1px solid #ddd; background-color:#ffffff;}
h1,h2,h3 { color:#111; }
ul { padding-left:1rem; }
</style>
</head>
<body>

<div class="container mx-auto p-6">
<header class="mb-8">
<h1 class="text-4xl font-bold mb-2">Investor Insights Dashboard</h1>
<p class="text-gray-600 text-lg">Visualize co-investors, domains, startups, and generate professional reports.</p>
</header>

<!-- Upload Section -->
<div class="card mb-8 flex flex-col md:flex-row gap-4 items-center">
<input type="file" id="csvFile" class="w-full md:w-1/2">
<button onclick="uploadCSV()" class="btn bg-gradient-to-r from-blue-400 to-purple-500 text-white px-6 py-3">Upload & Analyze</button>
<p id="uploadStatus" class="text-green-500 font-medium mt-2 md:mt-0"></p>
</div>

<!-- Dashboard Cards -->
<div id="insightsCards" class="hidden grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
<div class="card">
<h3 class="font-semibold text-lg mb-2">Overall Stats</h3>
<p id="statsOutput" class="text-gray-600"></p>
<p class="text-sm text-gray-400 mt-2">Shows total startups and unique investors.</p>
</div>
<div class="card">
<h3 class="font-semibold text-lg mb-2">Top Co-Investors</h3>
<ul id="coInvestorsList" class="text-gray-600"></ul>
<p class="text-sm text-gray-400 mt-2">Frequent co-investor partnerships.</p>
</div>
<div class="card">
<h3 class="font-semibold text-lg mb-2">Top Domains</h3>
<ul id="domainList" class="text-gray-600"></ul>
<p class="text-sm text-gray-400 mt-2">Most active startup sectors.</p>
</div>
</div>

<!-- Investor Search & Report -->
<div class="card mb-8">
<h2 class="text-xl font-semibold mb-4">Search Investor</h2>
<div class="flex flex-col md:flex-row gap-3 items-center">
<input type="text" id="investorName" placeholder="Enter Investor Name" class="w-full md:w-1/2">
<button onclick="fetchInvestor()" class="btn bg-gradient-to-r from-green-400 to-teal-500 text-white px-6 py-3">Show Insights</button>
<button onclick="downloadPDF()" class="btn bg-gradient-to-r from-gray-300 to-gray-400 text-black px-6 py-3">Download PDF Report</button>
</div>
<div id="investorInsights" class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6"></div>
</div>

<!-- Network Map -->
<div class="card mb-8">
<h2 class="text-xl font-semibold mb-2">Investor Network Map</h2>
<p class="text-sm text-gray-500 mb-4">Displays investor collaborations, domains, and startups they invest in.</p>
<div id="network" style="height:450px;"></div>
</div>

<!-- Charts -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
<div class="card">
<canvas id="coInvestorChart"></canvas>
<p class="text-sm text-gray-500 mt-3">Bar chart of most frequent co-investors.</p>
</div>
<div class="card">
<canvas id="domainChart"></canvas>
<p class="text-sm text-gray-500 mt-3">Bar chart of most active domains/startup sectors.</p>
</div>
</div>
</div>
<script>
let currentInvestor = "";

async function uploadCSV() {
    const fileInput = document.getElementById('csvFile');
    if(!fileInput.files[0]) { alert("Select a CSV"); return; }
    const formData = new FormData();
    formData.append('file', fileInput.files[0]);
    const res = await fetch('/api/upload', {method:'POST', body:formData});
    const data = await res.json();
    if(data.message){
        document.getElementById('uploadStatus').innerText = data.message;
        fetchInsights();
    } else alert(data.error);
}

async function fetchInsights(){
    const res = await fetch('/api/insights');
    const data = await res.json();
    if(data.error) return;

    document.getElementById('insightsCards').classList.remove('hidden');
    document.getElementById('statsOutput').innerText = `Startups: ${data.stats.n_startups}, Investors: ${data.stats.n_unique_investors}`;

    const coList = document.getElementById('coInvestorsList'); coList.innerHTML = '';
    data.top_co.forEach(i=>{ let li=document.createElement('li'); li.innerText=`${i[0]} (${i[1]})`; coList.appendChild(li); });

    const domainList = document.getElementById('domainList'); domainList.innerHTML = '';
    data.top_domains.forEach(d=>{ let li=document.createElement('li'); li.innerText=`${d[0]} (${d[1]})`; domainList.appendChild(li); });

    drawChart('coInvestorChart', data.top_co.map(x=>x[0]), data.top_co.map(x=>x[1]), 'Top Co-Investors','#4a90e2','#a1c4fd');
    drawChart('domainChart', data.top_domains.map(x=>x[0]), data.top_domains.map(x=>x[1]), 'Top Domains','#4a90e2','#a1c4fd');
}

async function fetchInvestor(){
    const name = document.getElementById('investorName').value.trim();
    if(!name) return alert("Enter investor name");
    currentInvestor = name;
    const res = await fetch(`/api/investor/${name}`);
    const data = await res.json();
    const div = document.getElementById('investorInsights');
    div.innerHTML = `
        <div class="card p-4 rounded-xl shadow">Startups:<ul>${data.startups.map(s=>`<li>${s}</li>`).join('')}</ul></div>
        <div class="card p-4 rounded-xl shadow">Domains:<ul>${data.domains.map(d=>`<li>${d[0]} (${d[1]})</li>`).join('')}</ul></div>
        <div class="card p-4 rounded-xl shadow">Co-Investors:<ul>${data.co_investors.map(c=>`<li>${c[0]} (${c[1]})</li>`).join('')}</ul></div>
    `;
    drawNetwork(name);
}

async function downloadPDF(){
    if(!currentInvestor) return alert("Search an investor first");
    const res = await fetch(`/api/generate-report/${currentInvestor}`);
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${currentInvestor}_report.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
}

async function drawNetwork(investor){
    const res = await fetch(`/api/network/${investor}`);
    const data = await res.json();
    const nodes = new vis.DataSet(data.nodes.map(n=>({
        id:n.id,
        label:n.id,
        color:n.type=='investor'?'#4a90e2':n.type=='domain'?'#50e3c2':'#f5a623'
    })));
    const edges = new vis.DataSet(data.links);
    const container = document.getElementById('network');
    new vis.Network(container,{nodes,edges},{});
}

function drawChart(id, labels, values, title){
    const ctx = document.getElementById(id).getContext('2d');
    const gradient = ctx.createLinearGradient(0,0,0,400);
    gradient.addColorStop(0,'#6ee7b7'); // pastel green
    gradient.addColorStop(1,'#3b82f6'); // pastel blue
    new Chart(ctx,{
        type:'bar',
        data:{labels, datasets:[{label:title,data:values,backgroundColor:gradient}]},
        options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true},x:{ticks:{color:'#111'}}}}
    });
}
</script>

</body>
</html>
